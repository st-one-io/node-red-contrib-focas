<!-- 
  Copyright: (c) 2018-2020, Smart-Tech Controle e Automação
  GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt) 
-->

<!-- --< Begin >--------- Focas Config (focas config) ---------------------- -->
<script type="text/x-red" data-template-name="focas config">

    <div class="form-row">
        <label for="node-config-input-name">
            <i class="fa fa-tag"></i>
            <span data-i18n="focas.util.label.name"></span>
        </label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]focas.util.label.name">
    </div>

    <div class="form-row">
        <label for="node-config-input-cncIP">
            <i class="fa fa-home"></i>
            <span data-i18n="focas.config.label.ip"></span>
        </label>
        <input type="text" style="width: 30%" id="node-config-input-cncIP" data-i18n="[placeholder]focas.config.label.ip">

        <span style="margin-left:10px" data-i18n="focas.config.label.port"></span>
        <input type="text" id="node-config-input-cncPort" style="width: 60px;" data-i18n="[placeholder]focas.config.label.port">
    </div>

    <div class="form-row">
        <label for="node-config-input-timeout">
            <i class="fa fa-clock-o"></i>
            <span data-i18n="focas.config.label.timeout"></span>
        </label>
        <input type="text" id="node-config-input-timeout"> seconds
    </div>

    <div class="form-row">
        <label for="node-config-input-retries">
            <i class="fa fa-repeat"></i>
            <span data-i18n="focas.config.label.retries"></span>
        </label>
        <input type="text" id="node-config-input-retries"> times
    </div>

    <!-- <div class="form-row">
        <label for="node-config-input-cncModel">
            <i class="fa fa-link"></i>
            <span data-i18n="focas.config.label.force-link-layer"></span>
        </label>
        <select type="text" id="node-config-input-cncModel">
            <option value="auto" data-i18n="focas.config.label.options.auto"></option>
            <option value="true" data-i18n="focas.config.label.options.true"></option>
            <option value="false" data-i18n="focas.config.label.options.false"></option>
        </select>
    </div> -->

</script>

<script type="text/x-red" data-help-name="focas config">
    <!-- <p>This node was created by <a href="https://netsmarttech.com" target="_blank">Smart-Tech</a> as part of the <a href="https://netsmarttech.com/page/st-one" target="_blank">ST-One</a> project</p>
    
    <h3>Options</h3>
    <dl class="message-properties">
        <dt>Controller
            <span class="property-type">IP Address</span>
        </dt>
        <dd> ip address of controller. </dd>
    
        <dt>Port
            <span class="property-type">Number</span>
        </dt>
        <dd> port of controller. </dd>
    
        <dt>KeepAlive
            <span class="property-type">Number</span>
        </dt>
        <dd> max time without communication. </dd>
    
        <dt>Timeout
            <span class="property-type">Number</span>
        </dt>
        <dd> max time without connection. </dd>
    
        <dt>Retries
            <span class="property-type">Number</span>
        </dt>
        <dd> retries of connection. </dd>
    
        <dt>Link Layer
            <span class="property-type">Link Layer</span>
        </dt>
        <dd> Link Layer mode, 
            <code>Auto</code>: auto negotiation,
            <code>True</code>: force link layer,
            <code>False</code>: disable link layer
        </dd>
    
        <dt>Disable MID parsing
            <span class="property-type">String</span>
        </dt>
        <dd> receiver MIDs with body not parsing. </dd>
    
        <dt>Raw Data
            <span class="property-type">Boolean</span>
        </dt>
        <dd> adds the parameter <code>_raw</code> in all messages, containing the message buffer. </dd>
    
        <dt>Generic Mode
            <span class="property-type">Boolean</span>
        </dt>
        <dd> the nodes use calls generics. </dd>
    
    </dl> -->

</script>

<script type="text/javascript">
    RED.nodes.registerType('focas config', {
        category: 'config',
        color: '#FFAAAA',
        defaults: {
            name: {
                value: ""
            },
            cncIP: {
                value: "",
                required: true
            },
            cncPort: {
                value: 4545,
                required: true
            },
            timeout: {
                value: 3
            },
            retries: {
                value: 3
            },
            // cncModel: {
            //     value: "default"
            // }
        },
        label: function () {

            if (this.name) {
                return this.name;
            }

            let name = this.cncIP;

            return name;
        },
        oneditprepare: function () {
            $("#node-config-input-timeout").spinner({
                min: 0
            });
            $("#node-config-input-retries").spinner({
                min: 0
            });
        }
    });
</script>
<!-- --< End >--------- Focas Config (focas config) ---------------------- -->


<!-- --< Begin >--------- Focas Node (focas node) ---------------------- -->

<script type="text/x-red" data-template-name="focas node">

    <div class="form-row">
        <label for="node-input-config">
            <i class="fa fa-cog"></i>
            <span data-i18n="focas.node.label.config"></span>
        </label>
        <input type="text" id="node-input-config" data-i18n="[placeholder]focas.node.label.config">
    </div>

    <div class="form-row">
        <label for="node-input-function">
            <i class="fa fa-link"></i>
            <span data-i18n="focas.node.label.fn"></span>
        </label>
        <select style="width:70%;" id="node-input-function"></select>
    </div>

    <!-- <div class="form-row" id="div-forward-errors">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-forwardErrors" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-forwardErrors" style="width:70%;">
            <span data-i18n="focas.node.label.forward-errors"></span>
        </label>
    </div> -->

    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i>
            <span data-i18n="focas.util.label.name"></span>
        </label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]focas.util.label.name">
    </div>

    <div class="form-tips" id="div-tips">
        <div id="code-info" style="height:auto; width:90%; font-family: monospace"></div>
    </div>


</script>

<script type="text/x-red" data-help-name="focas node">
    <!-- <p>Tool communication using OpenProtocol</p>
    <p>This node was created by <a href="https://netsmarttech.com" target="_blank">Smart-Tech</a> as part of the <a href="https://netsmarttech.com/page/st-one" target="_blank">ST-One</a> project</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <p> Use the parameters according to tips in node. </p>
        <dt>
            payload
            <span class="property-type"> string | buffer | object </span>
        </dt>
        <dt>
            subscribe
            <span class="property-type"> boolean </span>
        </dt>
    </dl>
    
    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>Feedback
            <dl class="message-properties">
                <dt> msg <span class="property-type"> object </object></span> </dt>
                <dd> header of MID. </dd>
    
                <dt> msg.payload <span class="property-type"> object | string </object></span> </dt>
                <dd> body of MID. </dd>
            </dl>
        </li>
    
        <li>Data
            <p> Available in <code>subscribe</code> and <code>custom</code> options. </p>
            <dl class="message-properties">
                <dt> msg <span class="property-type"> object </object></span> </dt>
                <dd> header of MID. </dd>
    
                <dt> msg.payload <span class="property-type"> object | string </object></span> </dt>
                <dd> body of MID. </dd>
            </dl>
        </li>
    </ol>
    
    <h3>Options</h3>
    <dl class="message-properties">
        <dt>Config
            <span class="property-type">OP Controller</span>
        </dt>
        <dd> select controller. </dd>
    
        <dt>Mid Group
            <span class="property-type">MID Group</span>
        </dt>
        <dd> select function this node. </dd>
    
        <dt>Revision
            <span class="property-type">Revision</span>
        </dt>
        <dd> select revision for MID Group, 
            <code>Auto</code>: auto negotiation,
            <code>Custom</code>: add revision not listed
        </dd>
    
        <dt>Custom revision
            <span class="property-type">Number</span>
        </dt>
        <dd> add number of custom revision. </dd>
    
        <dt>Auto Subscribe
            <span class="property-type">Boolean</span>
        </dt>
        <dd> active auto subscribe on start. </dd>
    
        <dt>Forward Errors
            <span class="property-type">Boolean</span>
        </dt>
        <dd> this option adds parameter <code>msg.error</code> in error cases. </dd>
    </dl> -->

</script>

<script type="text/javascript">
    (function () {

        let base = {
            "1": {
                "text": "1 - cncStatInfo",
                "params": []
            }
        };

        RED.nodes.registerType('focas node', {
            category: 'advanced',
            color: '#E2D96E',
            defaults: {
                name: {
                    value: ""
                },
                config: {
                    value: "",
                    type: "focas config"
                },
                function: {
                    value: "",
                    required: true
                },
                // forwardErrors: {
                //     value: false
                // },
                outputs: {
                    value: 1
                }
            },
            inputs: 1,
            outputs: 1,
            icon: "function.svg",
            paletteLabel: "focas",
            outputLabels: function (index) {

                // TODO: Estudar melhores labels

                // if (index === 0) {
                //     return this._("focas.util.label.feedback");
                // }

                // if (index === 1) {
                //     return this._("focas.util.label.data");
                // }

                // if (index === 2) {
                //     return this._("focas.util.label.status-alarm");
                // }

                // if (index === 3) {
                //     return this._("focas.util.label.ack-alarm");
                // }

            },
            label: function () {

                if (this.name) {
                    return this.name;
                }

                var name = "";

                if (!this.function) {
                    return this._("focas.util.label.node");
                }

                if (name === "") {
                    name = base[this.function];
                }

                return name;
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function () {

                let base_function = Object.keys(base);

                let node = this;

                const select_function = $("#node-input-function");

                atualizaFunction();

                // --- Changes
                // select_function.change(() => {
                //     controlaInterface();
                //     atualizaOutputs();
                // });

                // --- <Begin> -- Functions ---

                function atualizaFunction() {

                    // let subCategories = {
                    //     "SUBSCRIBE": $('<optgroup>').prop('label', 'Subscriptions'),
                    //     "REQUEST": $('<optgroup>').prop('label', 'Requests'),
                    //     "COMMAND": $('<optgroup>').prop('label', 'Commands'),
                    //     "CONTROL": $('<optgroup>').prop('label', 'Controls')
                    // };

                    // base_midGroup.forEach(item => {

                    //     //issue #2 - Remove MidGroups 3 e 9999
                    //     if (item === '3' || item === '9999') {
                    //         return;
                    //     }

                    //     let option = $(`<option>`).val(item).text(base[item].text);
                    //     subCategories[base[item].typeRequest].append(option);
                    // });

                    // subCategories["CONTROL"].append($(`<option>`).val("Connect").text("Connection"));
                    // subCategories["CONTROL"].append($(`<option>`).val("Custom").text("Custom MID"));

                    base_function.forEach(item => {
                        select_function.append($(`<option>`).val(item).text(base[item].text));
                    });
                    
                        
                    // select_function.append(subCategories["SUBSCRIBE"]);
                    // select_function.append(subCategories["REQUEST"]);
                    // select_function.append(subCategories["COMMAND"]);
                    // select_function.append(subCategories["CONTROL"]);

                    if (node.function) {
                        select_function.val(node.function);
                    }

                    if (select_function.val() === "") {
                        select_function.val("1");
                    }
                }

                function controlaInterface() {

                    // let localMidGroup = select_midGroup.val();
                    // let localRevision = select_revision.val();

                    // const div_customMid = $("#div-custom-mid");
                    // const div_revision = $("#div-revision");
                    // const div_customRevision = $("#div-custom-revision");
                    // const div_autoSubscribe = $("#div-auto-subscribe");
                    // const div_forwardErrors = $("#div-forward-errors");
                    // const div_tips = $("#div-tips");

                    // div_customMid.hide();
                    // div_revision.hide();
                    // div_customRevision.hide();
                    // div_autoSubscribe.hide();
                    // div_tips.hide();

                    // if (!localMidGroup) {
                    //     return;
                    // }

                    // if (localMidGroup === "Connect") {
                    //     div_tips.show();
                    //     return;
                    // }

                    // if (localMidGroup === "Custom") {
                    //     div_tips.show();
                    //     return;
                    // }

                    // if (localRevision === "Custom") {
                    //     div_revision.show();
                    //     div_customRevision.show();
                    //     return;
                    // }

                    // let detalhes = base[localMidGroup];

                    // if (detalhes.implemented && detalhes.typeRequest === "SUBSCRIBE" && detalhes.params
                    //     .length === 0) {
                    //     div_autoSubscribe.show();
                    // }

                    // div_revision.show();

                    // if (localRevision) {
                    //     div_tips.show();
                    // }
                }

                function atualizaTips() {

                    // let codeInfo = $("#code-info");
                    // let localMidGroup = select_midGroup.val();
                    // let localRevision = select_revision.val();

                    // if (!localMidGroup) {
                    //     return;
                    // }

                    // if (localMidGroup === "Connect") {
                    //     let content = node._("focas.tips.connect");
                    //     codeInfo.html(content);
                    //     return;
                    // }

                    // if (localMidGroup === "Custom") {
                    //     let content = node._("focas.tips.custom");
                    //     codeInfo.html(content);
                    //     return;
                    // }

                    // let detalhes = base[localMidGroup];

                    // let content = "";

                    // if (!detalhes.implemented) {
                    //     content = `<h4>${detalhes.typeRequest} - ${detalhes.family}<\/h4>` +
                    //         node._("focas.tips.not-implemented");

                    //     codeInfo.html(content);
                    //     return;
                    // }

                    // if (detalhes.params.length === 0 && detalhes.typeRequest !== "SUBSCRIBE") {

                    //     content = `<h4>${detalhes.typeRequest} - ${detalhes.family}<\/h4>` +
                    //         node._("focas.tips.not-params");

                    //     codeInfo.html(content);
                    //     return;

                    // }

                    // if (detalhes.params.length === 0 && detalhes.typeRequest === "SUBSCRIBE") {

                    //     content = `<h4>${detalhes.typeRequest} - ${detalhes.family}<\/h4>` +
                    //         node._("focas.tips.subscribe");

                    //     codeInfo.html(content);
                    //     return;
                    // }

                    // if (localRevision && localRevision !== "Auto" && localRevision !== "Custom") {

                    //     content = `<h4>${detalhes.typeRequest} - ${detalhes.family}<\/h4>` +
                    //         node._("focas.tips.params.header") +
                    //         `<h6>Revision: ${localRevision} </h6>` +
                    //         "<code>msg.payload = {}<\/code><br>";

                    //     detalhes.params[localRevision].forEach((value) => {

                    //         let param = node._("focas.tips.params.tags.param");
                    //         let type = node._("focas.tips.params.tags.type");
                    //         let desc = node._("focas.tips.params.tags.description");

                    //         let local = "<blockquote>" +
                    //             `${param}: <code>msg.payload.${value.name}</code> <br>` +
                    //             `${type}: <code>${value.type}</code> <br>` +
                    //             `${desc}: ${value.desc}</blockquote>`;

                    //         content = content.concat(local);

                    //     });

                    //     codeInfo.html(content);
                    //     return;
                    // }
                    // codeInfo.html("");
                }

                function atualizaOutputs() {

                    // let localMidGroup = select_midGroup.val();

                    // if (!localMidGroup) {
                    //     return;
                    // }

                    // if (localMidGroup === "Custom") {
                    //     node.outputs = 1;
                    //     return;
                    // }

                    // if (localMidGroup === "Connect") {
                    //     node.outputs = 1;
                    //     return;
                    // }

                    // if (localMidGroup === "71") {
                    //     node.outputs = 4;
                    //     return;
                    // }

                    // let typeRequest = base[localMidGroup].typeRequest;

                    // if (typeRequest === "SUBSCRIBE") {
                    //     node.outputs = 2;
                    // } else {
                    //     node.outputs = 1;
                    // }
                }

                // --- <End> -- Functions ---
            }
        });

    })();
</script>

<!-- --< End >--------- Focas Node (focas node) ---------------------- -->
