<!-- 
  Copyright: (c) 2018-2020, Smart-Tech Controle e Automação
  GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt) 
-->

<!-- --< Begin >--------- Focas Config (focas config) ---------------------- -->
<script type="text/html" data-template-name="focas config">

    <div class="form-row">
        <label for="node-config-input-name">
            <i class="fa fa-tag"></i>
            <span data-i18n="focas.util.label.name"></span>
        </label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]focas.util.label.name">
    </div>

    <div class="form-row">
        <label for="node-config-input-cncIP">
            <i class="fa fa-home"></i>
            <span data-i18n="focas.config.label.ip"></span>
        </label>
        <input type="text" style="width: 30%" id="node-config-input-cncIP" data-i18n="[placeholder]focas.config.label.ip">

        <span style="margin-left:10px" data-i18n="focas.config.label.port"></span>
        <input type="text" id="node-config-input-cncPort" style="width: 60px;" data-i18n="[placeholder]focas.config.label.port">
    </div>

    <div class="form-row">
        <label for="node-config-input-timeout">
            <i class="fa fa-clock-o"></i>
            <span data-i18n="focas.config.label.timeout"></span>
        </label>
        <input type="text" id="node-config-input-timeout"> seconds
    </div>

    <div class="form-row">
        <label for="node-config-input-retries">
            <i class="fa fa-repeat"></i>
            <span data-i18n="focas.config.label.retries"></span>
        </label>
        <input type="text" id="node-config-input-retries"> times
    </div>

    <div class="form-row">
        <label for="node-config-input-cncModel">
            <i class="fa fa-link"></i>
            <span data-i18n="focas.config.label.models"></span>
        </label>
        <select type="text" id="node-config-input-cncModel">
            <option value="0i-D">0i-D</option>
        </select>
    </div>

</script>

<script type="text/html" data-help-name="focas config">
    <!-- <p>This node was created by <a href="https://netsmarttech.com" target="_blank">Smart-Tech</a> as part of the <a href="https://netsmarttech.com/page/st-one" target="_blank">ST-One</a> project</p>
    
    <h3>Options</h3>
    <dl class="message-properties">
        <dt>Controller
            <span class="property-type">IP Address</span>
        </dt>
        <dd> ip address of controller. </dd>
    
        <dt>Port
            <span class="property-type">Number</span>
        </dt>
        <dd> port of controller. </dd>
    
        <dt>KeepAlive
            <span class="property-type">Number</span>
        </dt>
        <dd> max time without communication. </dd>
    
        <dt>Timeout
            <span class="property-type">Number</span>
        </dt>
        <dd> max time without connection. </dd>
    
        <dt>Retries
            <span class="property-type">Number</span>
        </dt>
        <dd> retries of connection. </dd>
    
        <dt>Link Layer
            <span class="property-type">Link Layer</span>
        </dt>
        <dd> Link Layer mode, 
            <code>Auto</code>: auto negotiation,
            <code>True</code>: force link layer,
            <code>False</code>: disable link layer
        </dd>
    
        <dt>Disable MID parsing
            <span class="property-type">String</span>
        </dt>
        <dd> receiver MIDs with body not parsing. </dd>
    
        <dt>Raw Data
            <span class="property-type">Boolean</span>
        </dt>
        <dd> adds the parameter <code>_raw</code> in all messages, containing the message buffer. </dd>
    
        <dt>Generic Mode
            <span class="property-type">Boolean</span>
        </dt>
        <dd> the nodes use calls generics. </dd>
    
    </dl> -->

</script>

<script type="text/javascript">
    RED.nodes.registerType('focas config', {
        category: 'config',
        color: '#FFAAAA',
        defaults: {
            name: {
                value: ""
            },
            cncIP: {
                value: "",
                required: true
            },
            cncPort: {
                value: 4545,
                required: true
            },
            timeout: {
                value: 3,
                required: true
            },
            retries: {
                value: 3,
                required: true
            },
            cncModel: {
                value: "0i-D",
                required: true
            }
        },
        label: function () {

            if (this.name) {
                return this.name;
            }

            let name = this.cncModel + "@" + this.cncIP;

            return name;
        },
        oneditprepare: function () {
            $("#node-config-input-timeout").spinner({
                min: 3
            });
            $("#node-config-input-retries").spinner({
                min: 3
            });
        }
    });
</script>
<!-- --< End >--------- Focas Config (focas config) ---------------------- -->


<!-- --< Begin >--------- Focas Node (focas node) ---------------------- -->

<script type="text/html" data-template-name="focas node">

    <div class="form-row">
        <label for="node-input-config">
            <i class="fa fa-cog"></i>
            <span data-i18n="focas.node.label.config"></span>
        </label>
        <input type="text" id="node-input-config" data-i18n="[placeholder]focas.node.label.config">
    </div>

    <div class="form-row">
        <label for="node-input-function">
            <i class="fa fa-link"></i>
            <span data-i18n="focas.node.label.fn"></span>
        </label>
        <select style="width:70%;" id="node-input-function"></select>
    </div>

    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i>
            <span data-i18n="focas.util.label.name"></span>
        </label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]focas.util.label.name">
    </div>

    <div class="form-tips" id="div-tips">
        <div id="code-info" style="height:auto; width:90%; font-family: monospace"></div>
    </div>


</script>

<script type="text/html" data-help-name="focas node">
    <!-- <p>Tool communication using OpenProtocol</p>
    <p>This node was created by <a href="https://netsmarttech.com" target="_blank">Smart-Tech</a> as part of the <a href="https://netsmarttech.com/page/st-one" target="_blank">ST-One</a> project</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <p> Use the parameters according to tips in node. </p>
        <dt>
            payload
            <span class="property-type"> string | buffer | object </span>
        </dt>
        <dt>
            subscribe
            <span class="property-type"> boolean </span>
        </dt>
    </dl>
    
    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>Feedback
            <dl class="message-properties">
                <dt> msg <span class="property-type"> object </object></span> </dt>
                <dd> header of MID. </dd>
    
                <dt> msg.payload <span class="property-type"> object | string </object></span> </dt>
                <dd> body of MID. </dd>
            </dl>
        </li>
    
        <li>Data
            <p> Available in <code>subscribe</code> and <code>custom</code> options. </p>
            <dl class="message-properties">
                <dt> msg <span class="property-type"> object </object></span> </dt>
                <dd> header of MID. </dd>
    
                <dt> msg.payload <span class="property-type"> object | string </object></span> </dt>
                <dd> body of MID. </dd>
            </dl>
        </li>
    </ol>
    
    <h3>Options</h3>
    <dl class="message-properties">
        <dt>Config
            <span class="property-type">OP Controller</span>
        </dt>
        <dd> select controller. </dd>
    
        <dt>Mid Group
            <span class="property-type">MID Group</span>
        </dt>
        <dd> select function this node. </dd>
    
        <dt>Revision
            <span class="property-type">Revision</span>
        </dt>
        <dd> select revision for MID Group, 
            <code>Auto</code>: auto negotiation,
            <code>Custom</code>: add revision not listed
        </dd>
    
        <dt>Custom revision
            <span class="property-type">Number</span>
        </dt>
        <dd> add number of custom revision. </dd>
    
        <dt>Auto Subscribe
            <span class="property-type">Boolean</span>
        </dt>
        <dd> active auto subscribe on start. </dd>
    
        <dt>Forward Errors
            <span class="property-type">Boolean</span>
        </dt>
        <dd> this option adds parameter <code>msg.error</code> in error cases. </dd>
    </dl> -->

</script>

<script type="text/javascript">
    (function () {

        let base = {
            "1": {
                "text": "1 - cncStatInfo",
                "params": []
            },
            "2": {
                "text": "2 - cncSysInfo",
                "params": []
            },
            "3": {
                "text": "3 - cncRdProgNum",
                "params": []
            },

            "4": {
                "text": "4 - cncRdAxisData",
                "params": [{"name": "class", 
                            "type": "number", 
                            "desc": "<br> 1 : Position value.<br>\
                                          2 : Servo.<br>\
                                          3 : Spindle.<br>\
                                          4 : Selected spindle.<br>\
                                          5 : Speed."},
                            {"name": "type", 
                            "type": "array", 
                            "desc": "Kind of data to be read. Refer to FOCAS documentation for more details."},
                            {"name": "length", 
                            "type": "number", 
                            "desc": "The number of axes to be read."}]
                            
            }
        };

        RED.nodes.registerType('focas node', {
            category: 'advanced',
            color: '#E2D96E',
            defaults: {
                name: {
                    value: ""
                },
                config: {
                    value: "",
                    type: "focas config"
                },
                function: {
                    value: "",
                    required: true
                }
            },
            inputs: 1,
            outputs: 1,
            icon: "function.svg",
            paletteLabel: "FOCAS",
            label: function () {

                if (this.name) {
                    return this.name;
                }

                if (this.function) {
                    var wordsArr = base[this.function].text.split(" ");
                    return wordsArr[wordsArr.length - 1];
                } else {
                    return this._("focas.util.label.node");
                }
                
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function () {

                let base_function = Object.keys(base);

                let node = this;

                const select_function = $("#node-input-function");

                updateFunction();

                // --- Changes
                select_function.change(() => {
                    updateInterface();
                    updateTips()
                });

                // --- <Begin> -- Functions ---

                function updateFunction() {

                    base_function.forEach(item => {
                        select_function.append($(`<option>`).val(item).text(base[item].text));
                    });

                    if (node.function) {
                        select_function.val(node.function);
                    }

                    if (select_function.val() === "") {
                        select_function.val("1");
                    }
                }

                function updateInterface() {

                    let localFunction = select_function.val();
                    
                    const div_tips = $("#div-tips");

                    if (!localFunction) {
                        return;
                    } else {
                        div_tips.show();
                    }
                }

                function updateTips() {

                    let codeInfo = $("#code-info");
                    let localFunction = select_function.val();

                    if (!localFunction) {
                        return;
                    }

                    let details = base[localFunction];

                    let content = "";

                    if (details.params.length === 0) {
                        content = `<h4>${details.text}<\/h4>` + node._("focas.tips.not-params");
                        codeInfo.html(content);
                        return;
                    } else {
                        content = `<h4>${details.text}<\/h4>` +
                            node._("focas.tips.params.header") +
                            "<code>msg.payload = {}<\/code><br>";

                        details.params.forEach((value) => {
                            let param = node._("focas.tips.params.tags.param");
                            let type = node._("focas.tips.params.tags.type");
                            let desc = node._("focas.tips.params.tags.description");

                            let local = "<blockquote>" +
                                `${param}: <code>msg.payload.${value.name}</code> <br>` +
                                `${type}: <code>${value.type}</code> <br>` +
                                `${desc}: ${value.desc}</blockquote>`;

                            content = content.concat(local);
                        });

                        codeInfo.html(content);
                        return;
                    }

                    codeInfo.html("");
                }

                // --- <End> -- Functions ---
            }
        });

    })();
</script>

<!-- --< End >--------- Focas Node (focas node) ---------------------- -->
